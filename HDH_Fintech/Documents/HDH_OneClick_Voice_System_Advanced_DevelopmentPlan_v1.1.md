# HDH 원클릭·음성 기반 동시 진입 시스템 고급 개발계획서 (Advanced Edition v1.1)

## 1. 개요 (Overview)

본 문서는 HDH 전략의 구조적 안정성을 확보하기 위한 핵심 시스템인 '원클릭·음성 기반 동시 진입·동시 청산 시스템'의 구체적 개발 설계 문서이다.

**v1.1 업데이트**: 2차 펀딩 금액 트레이딩 단계 자동화 섹션 추가

HDH 전략은 **2단계 프로세스**로 구성됨:
- **1차 단계**: 챌린지 계좌 + 보험금 계좌 동시 진입/청산
- **2차 단계**: 펀딩 계좌 A + 펀딩 계좌 B 헷지 트레이딩 및 자동 청산

두 계좌가 동일 포지션을 동일한 시점에 실행해야만 전략이 성립함에 따라, 수동 방식의 체결 오차를 제거하고, 자동화된 동기화·계산·체결 시스템으로 전환하는 것이 목적이다.

---

## 2. 개발 목적 및 필수 요구사항

### 1차 챌린지 단계
- 두 계좌의 동시 진입/청산을 50ms 이하 오차 범위로 수행
- 인간 입력(방향, LOT, SL·TP) 오류 제거
- 외부에서 제공되는 TP·SL 값을 자동 수신·검증·반영
- SL·TP 자동 계산 및 비율 유지(5.24 구조 검증)
- 변동성/스프레드/서버상태 리스크 자동 검출 및 차단
- 음성 기반 명령으로 즉시 매매 가능
- 실시간 체결 검증 및 예외처리

### 2차 펀딩 단계 (v1.1 신규)
- **두 개의 펀딩 계좌(A, B) 동시 모니터링**
- **한쪽 계좌 Stop Loss 이벤트 실시간 감지**
- **반대 계좌 즉시 시장가 청산 자동 실행**
- **타이밍 오차 최소화 (목표: 20-80ms 이내)**
- 양방향 이벤트 감지 (A→B, B→A 모두 대응)
- 청산 실패 시 자동 재시도 메커니즘

---

## 3. 시스템 구성도 (System Architecture)

### 3.1 1차 챌린지 단계 시스템

1. 사용자 입력(원클릭 UI 또는 음성 명령)
2. 명령 처리 엔진
3. 파라미터 자동 계산 엔진
   - 외부 제공 SL·TP 수신
   - LOT 자동 계산
   - 비율(5.24) 자동 검증
4. 위험 감지 엔진
   - 스프레드 감지
   - 변동성 감지
   - 서버 Ping 감지
5. 동시 주문 API 모듈
   - 챌린지 계좌 주문
   - 보험금 계좌 주문
6. 체결 검증 엔진
   - 부분체결·미체결 처리
7. 예외처리 및 경보 시스템

### 3.2 2차 펀딩 단계 시스템 (v1.1 신규)

```
[MT5 인스턴스 #1 - 펀딩 계좌 A]
  ├─ EA_Monitor_A.mq5
  │   ├─ OnTradeTransaction() - SL 이벤트 감지
  │   ├─ GlobalVariableSet("A_SL_HIT", timestamp) - 신호 송신
  │   └─ OnTimer(5ms) - "B_SL_HIT" 신호 수신 대기
  │       └─ 감지 시 → 즉시 CloseAllPositions()

[MT5 인스턴스 #2 - 펀딩 계좌 B]
  ├─ EA_Monitor_B.mq5
  │   ├─ OnTradeTransaction() - SL 이벤트 감지
  │   ├─ GlobalVariableSet("B_SL_HIT", timestamp) - 신호 송신
  │   └─ OnTimer(5ms) - "A_SL_HIT" 신호 수신 대기
  │       └─ 감지 시 → 즉시 CloseAllPositions()

[통신 계층]
  ├─ GlobalVariables (5-20ms 지연)
  └─ 백업: 파일 기반 통신 (10-50ms 지연)
```

**핵심 아키텍처**:
- 2개의 독립된 MT5 터미널 설치 (서로 다른 폴더)
- 각 터미널에 커스텀 EA 로드
- GlobalVariables를 통한 크로스 인스턴스 통신
- 양방향 대칭 구조로 상호 모니터링

---

## 4. 주요 기능 상세 정의

## 4.1 원클릭 동시 진입 시스템 (1차 단계)

- 버튼 1회 클릭으로 두 계좌에 동시에 Market 주문 실행
- LOT 자동 계산 후 즉시 적용
- TP·SL 자동 반영(외부 제공값 기반)
- 실행 전 위험 감지(스프레드·변동성·뉴스·서버상태) 필수

## 4.2 음성 기반 진입 시스템 (1차 단계)

- Whisper API 기반 초저지연 음성→텍스트 변환
- '매수', '매도', '전체청산', '손절조정', '익절조정' 등 명령 지원
- 오인식 방지 알고리즘 적용(Double Confirm 옵션 포함)
- 음성 오류 시 즉시 차단 및 팝업/음성 안내 발생

## 4.3 자동 LOT 계산 엔진 (1차 단계)

- FAIL=-4.1p 지점에서 DD 규정 초과 없이 Fail 발생하도록 LOT 자동 계산
- 챌린지 LOT이 결정되면 보험금 LOT은 자동 연동
- LOT 계산식은 DD, SL, TP, 변동성 기반으로 주기적 업데이트 가능

## 4.4 외부 제공 SL·TP 자동 반영 모듈 (1차 단계)

- HDH 운영팀 또는 상위 트레이더가 제공하는 SL·TP 값을 자동 수신
- 수신 방식: API Webhook, REST Pull, 또는 로컬 입력 연동
- 수신된 값은 자동 검증(5.24 비율 유지 여부 확인)
- 검증 통과 시 즉시 매매 파라미터로 반영

## 4.5 위험 감지 엔진 (1차 단계)

- 스프레드 실시간 감지(예: > 2.0pip → 거래 금지)
- 변동성 감지(이전 1분 평균 대비 300% 상승 시 차단)
- Ping 검사(>150ms 시 경고)
- 뉴스 감지(Investing.com RSS 기반)

## 4.6 동시 주문 모듈 (1차 단계)

- MT5 API 기반 동시에 주문 송신
- 체결 오차 목표: 50~100ms
- 청산 명령은 우선순위 HIGH로 발송
- 서버 지연 시 재시도 및 자동 백업 절차 수행

## 4.7 2차 펀딩 단계 자동 청산 모듈 (v1.1 신규)

### 4.7.1 시스템 환경 구성

#### 하드웨어 구성 방안 비교

**방안 A: 컴퓨터 1대 (권장)**

```
[컴퓨터 1대]
  ├─ MT5 인스턴스 #1 (C:\MT5_Funding_A\) - 펀딩 계좌 A
  └─ MT5 인스턴스 #2 (C:\MT5_Funding_B\) - 펀딩 계좌 B

통신: GlobalVariables (내부 메모리)
```

**방안 B: 컴퓨터 2대**

```
[컴퓨터 #1]                    [컴퓨터 #2]
  └─ MT5 - 펀딩 계좌 A  ←───→  └─ MT5 - 펀딩 계좌 B

통신: 네트워크 (TCP/IP 소켓 또는 클라우드)
```

#### 방안 비교 분석

| 항목 | 컴퓨터 1대 (권장) | 컴퓨터 2대 |
|------|------------------|-----------|
| **설치 난이도** | ⭐⭐ 보통 | ⭐ 쉬움 |
| **통신 방식** | GlobalVariables (내부) | 네트워크 (TCP/IP) |
| **통신 지연** | **5-20ms** ✅ | 10-200ms |
| **안정성** | ⭐⭐⭐ 높음 | ⭐⭐ 중간 (네트워크 장애 위험) |
| **CPU/RAM 부담** | 높음 (MT5 2개 동시) | 낮음 (각 1개씩) |
| **비용** | 1대 비용 | 2대 비용 (추가) |
| **물리적 안전성** | 낮음 (1대 고장 시 전체 중단) | 높음 (1대 고장해도 작동) |
| **구현 복잡도** | 낮음 | 높음 (네트워크 코딩 필요) |
| **네트워크 장애** | 없음 ✅ | 있음 (Wi-Fi 끊김 등) |

#### 권장 구성: 컴퓨터 1대

**선택 이유**:
1. ✅ **타이밍이 가장 중요** - 5-20ms로 가장 빠른 응답속도
2. ✅ **구현이 단순** - 네트워크 프로그래밍 불필요
3. ✅ **네트워크 장애 위험 없음** - 내부 메모리 통신
4. ✅ **비용 효율적** - 추가 컴퓨터 불필요

**권장 사양**:
- CPU: Intel i5 이상 (또는 AMD Ryzen 5)
- RAM: 16GB 이상 (MT5 2개 + EA + 모니터링 UI)
- SSD: 256GB 이상
- OS: Windows 10/11 64bit

**대안 선택 기준**:
- 컴퓨터 성능 부족 시 → 컴퓨터 2대 (단, 로컬 네트워크 필수)
- 물리적 백업 중요 시 → 컴퓨터 2대 + 유선 LAN 연결

#### MT5 인스턴스 설치 (컴퓨터 1대 기준)

**설치 경로 예시**:
```
C:\MT5_Funding_Account_A\terminal64.exe
C:\MT5_Funding_Account_B\terminal64.exe
```

- 각 폴더에 독립된 MT5 설치
- 펀딩 계좌 A, B 각각 로그인
- 동시 실행 가능

**제약사항**:
- MT5는 단일 터미널에서 하나의 계정만 로그인 가능
- 따라서 2개의 별도 설치 필수
- 계정 전환 시 EA가 자동 제거되므로 동시 운영 불가

### 4.7.2 EA 기능 명세

**EA_Monitor_A.mq5 (펀딩 계좌 A)**:

```mql5
// 핵심 함수 1: SL 이벤트 감지
void OnTradeTransaction(
    const MqlTradeTransaction& trans,
    const MqlTradeRequest& request,
    const MqlTradeResult& result
) {
    // 포지션 종료 감지
    if (trans.type == TRADE_TRANSACTION_DEAL_DELETE) {
        // SL로 인한 종료인지 확인
        if (IsStopLossTriggered(trans)) {
            // 신호 송신: 펀딩 계좌 B에게 즉시 청산 명령
            GlobalVariableSet("SIGNAL_A_SL_HIT", GetTickCount());

            // 로그 기록
            Print("펀딩 계좌 A - Stop Loss 감지! 계좌 B 청산 신호 송신");
        }
    }
}

// 핵심 함수 2: 반대 계좌 SL 신호 모니터링
void OnTimer() {  // 5ms 주기
    // 펀딩 계좌 B의 SL 신호 체크
    if (GlobalVariableCheck("SIGNAL_B_SL_HIT")) {
        datetime lastSignal = (datetime)GlobalVariableGet("SIGNAL_B_SL_HIT");

        // 중복 처리 방지 (1초 이내 신호만 유효)
        if (TimeCurrent() - lastSignal <= 1) {
            // 즉시 시장가 청산
            CloseAllPositionsMarket();

            // 신호 삭제 (중복 실행 방지)
            GlobalVariableDel("SIGNAL_B_SL_HIT");

            Print("펀딩 계좌 A - 계좌 B SL 감지, 즉시 청산 완료");
        }
    }
}

// 즉시 시장가 청산 함수
void CloseAllPositionsMarket() {
    for (int i = PositionsTotal() - 1; i >= 0; i--) {
        ulong ticket = PositionGetTicket(i);
        if (ticket > 0) {
            trade.PositionClose(ticket);  // 시장가 즉시 청산
        }
    }
}
```

**EA_Monitor_B.mq5 (펀딩 계좌 B)**:
- 동일한 로직을 A↔B 반대로 구현
- 상호 대칭 구조

### 4.7.3 통신 방식 상세

**주 통신 방식: GlobalVariables**

| 항목 | 내용 |
|------|------|
| 통신 메커니즘 | MT5 GlobalVariables (크로스 인스턴스 공유) |
| 신호 변수명 | `SIGNAL_A_SL_HIT`, `SIGNAL_B_SL_HIT` |
| 데이터 타입 | Timestamp (GetTickCount()) |
| 모니터링 주기 | 5ms (OnTimer) |
| 예상 지연 | 5-20ms |

**백업 통신 방식: 파일 기반**

GlobalVariables 실패 시 파일 통신으로 백업:
```
공유 파일 경로:
C:\MT5_Shared\signal_A_SL.txt
C:\MT5_Shared\signal_B_SL.txt
```

| 항목 | 내용 |
|------|------|
| 파일 포맷 | 텍스트 (타임스탬프 기록) |
| 모니터링 주기 | 10ms |
| 예상 지연 | 10-50ms |

### 4.7.4 타이밍 성능 목표

| 단계 | 목표 시간 |
|------|----------|
| SL 이벤트 감지 | <5ms |
| 신호 송신 (GlobalVariable) | <5ms |
| 신호 수신 (OnTimer 5ms 주기) | 0-5ms |
| 청산 주문 실행 | 10-30ms |
| 브로커 서버 응답 | 10-40ms |
| **총 예상 지연** | **20-80ms** |

**실전 예시**:
```
13:45:30.000 - 펀딩 계좌 A, 금 선물 가격 상승으로 SL 도달
13:45:30.005 - EA_Monitor_A OnTradeTransaction 감지
13:45:30.010 - GlobalVariableSet("SIGNAL_A_SL_HIT") 완료
13:45:30.015 - EA_Monitor_B OnTimer에서 신호 감지
13:45:30.020 - PositionClose() 실행
13:45:30.060 - 브로커 서버 체결 완료

총 경과 시간: 60ms
```

### 4.7.5 예외 처리

**1. 청산 실패 시 재시도**:
```mql5
int retryCount = 0;
while (PositionsTotal() > 0 && retryCount < 3) {
    CloseAllPositionsMarket();
    Sleep(50);  // 50ms 대기
    retryCount++;
}
```

**2. 통신 장애 대응**:
- GlobalVariables 실패 시 자동으로 파일 통신으로 전환
- 파일도 실패 시 경고음 발생 및 수동 개입 요청

**3. 중복 실행 방지**:
```mql5
static datetime lastProcessed = 0;
if (lastSignal == lastProcessed) return;  // 이미 처리함
lastProcessed = lastSignal;
```

**4. 네트워크 지연 모니터링**:
- 매 청산 실행 시 소요 시간 기록
- 80ms 초과 시 경고 로그 생성
- 200ms 초과 시 알림 발송

### 4.7.6 사용자 설정 옵션

EA 파라미터:

| 파라미터 | 기본값 | 설명 |
|---------|--------|------|
| `TimerIntervalMs` | 5 | OnTimer 호출 주기 (ms) |
| `SignalValidSeconds` | 1 | 신호 유효 시간 (초) |
| `MaxRetryCount` | 3 | 청산 재시도 최대 횟수 |
| `EnableFileBackup` | true | 파일 통신 백업 활성화 |
| `AlertOnSlowExecution` | true | 지연 시 알림 활성화 |
| `SlowExecutionThresholdMs` | 100 | 지연 알림 기준 (ms) |

### 4.7.7 보안 및 안정성

**1. EA 인증**:
- 각 EA는 고유 Magic Number로 식별
- 타 EA의 포지션은 건드리지 않음

**2. 계좌 검증**:
```mql5
// 시작 시 계좌 번호 확인
if (AccountInfoInteger(ACCOUNT_LOGIN) != EXPECTED_ACCOUNT_A) {
    Alert("잘못된 계좌입니다!");
    ExpertRemove();
}
```

**3. 로그 기록**:
- 모든 SL 이벤트 및 청산 실행 기록
- CSV 파일로 저장하여 사후 분석 가능

### 4.7.8 테스트 프로토콜

**단계 1: 시뮬레이션 테스트**
- 데모 계좌 2개로 EA 설치
- 수동으로 한쪽 SL 트리거
- 반대쪽 자동 청산 확인
- 타이밍 측정 (목표: <100ms)

**단계 2: 스트레스 테스트**
- 10회 연속 SL 트리거
- 100% 청산 성공률 확인
- 평균 지연 시간 측정

**단계 3: 실전 검증**
- 소액 펀딩 계좌로 실전 테스트
- 1주일 운영 후 로그 분석
- 이상 없을 시 본격 운영

---

## 5. 예외 처리 및 보안 구성

### 5.1 1차 단계

- 체결 실패 시 자동 재시도 1~2회
- 부분체결 발생 시 자동 보정 알고리즘 적용
- 음성 명령 오인식 시 자동 차단
- 계좌 로그인 정보 로컬 AES256 암호화 저장
- 시스템 실행 전 LOT/SL/TP 자동 검증

### 5.2 2차 단계 (v1.1 신규)

- 청산 실패 시 최대 3회 재시도
- GlobalVariables 통신 실패 시 파일 통신 자동 전환
- 중복 실행 방지 타임스탬프 검증
- 청산 지연 80ms 초과 시 경고 로그
- 200ms 초과 시 관리자 알림 발송
- 모든 SL/청산 이벤트 CSV 로그 기록

---

## 6. UI/UX 설계

### 6.1 1차 챌린지 단계 UI

- **주요 버튼**: BUY / SELL / CLOSE ALL / 값동기화 / 음성활성화
- **상태 표시**: 스프레드 상태 / 변동성 지수 / 서버Ping / 외부 TP·SL 값 최신 여부
- **음성 명령 상태**: 실시간 인식 텍스트 표시
- **오류 표시**: 팝업 + 음성 안내 병행

### 6.2 2차 펀딩 단계 모니터링 UI (v1.1 신규)

**모니터링 대시보드**:

```
┌─────────────────────────────────────────────┐
│  HDH 펀딩 단계 모니터링 (v1.1)              │
├─────────────────────────────────────────────┤
│                                             │
│  [펀딩 계좌 A]           [펀딩 계좌 B]      │
│  상태: 🟢 실행 중         상태: 🟢 실행 중   │
│  포지션: LONG            포지션: SHORT      │
│  현재가: 2,650.50        현재가: 2,650.50   │
│  손익: +$450             손익: -$380        │
│  SL: 2,629.0             SL: 2,671.5        │
│                                             │
│  통신 상태: 🟢 정상 (지연: 12ms)            │
│  마지막 신호 체크: 0.003초 전               │
│                                             │
│  [실시간 로그]                              │
│  13:45:30 - 계좌 A SL 감지                  │
│  13:45:30 - 계좌 B 청산 실행 (55ms)        │
│  13:45:30 - 청산 완료                       │
│                                             │
│  [수동 제어]                                │
│  [ 전체 청산 ]  [ EA 중지 ]  [ 로그 보기 ] │
└─────────────────────────────────────────────┘
```

**상태 표시 항목**:
- 각 계좌 연결 상태 (🟢 정상 / 🔴 오류)
- 현재 포지션 정보
- 실시간 손익
- EA 통신 지연 시간
- 마지막 신호 체크 시각

**알림 기능**:
- SL 감지 시 알림음
- 청산 완료 시 확인 메시지
- 지연 발생 시 경고음

---

## 7. 확장 기능 (Advanced Features)

### 7.1 1차 단계

- AI 기반 변동성 예측 기능
- 체결속도 지연 자동 로그 분석
- 전략값 자동 업데이트 및 히스토리 관리
- API 장애 발생 시 자동 백업 브로커 전환 옵션

### 7.2 2차 단계 (v1.1 신규)

- **청산 타이밍 최적화 AI**
  - 과거 SL 발생 후 가격 변동 패턴 학습
  - 최적 청산 타이밍 예측 (SL 직후 vs 소폭 대기)

- **손익 최적화 알고리즘**
  - 청산 시 시장가 vs 지정가 선택 알고리즘
  - 변동성 낮을 때: 지정가로 슬리피지 최소화
  - 변동성 높을 때: 시장가로 확실한 청산

- **백테스팅 모듈**
  - 과거 데이터로 EA 성능 시뮬레이션
  - 평균 청산 지연 시간 측정
  - 타이밍 오차로 인한 손익 영향 분석

- **멀티 브로커 대응**
  - FTMO, MyForexFunds 등 다른 프롭펌 지원
  - 브로커별 서버 지연 자동 보정

---

## 8. 개발 단계별 로드맵

### Phase 1: 1차 챌린지 단계 구현 (기존)
- 원클릭 UI 개발
- 음성 명령 시스템 구현
- LOT 자동 계산 엔진
- 위험 감지 모듈
- 동시 주문 API 연동

### Phase 2: 2차 펀딩 단계 구현 (v1.1)
- **Week 1-2**: EA 기본 구조 개발
  - OnTradeTransaction 기반 SL 감지
  - GlobalVariables 통신 구현
  - 기본 청산 로직 구현

- **Week 3**: 통신 및 예외 처리
  - 파일 통신 백업 시스템
  - 재시도 메커니즘
  - 타이밍 최적화

- **Week 4**: 테스트 및 검증
  - 데모 계좌 시뮬레이션
  - 스트레스 테스트
  - 실전 소액 검증

- **Week 5**: UI 및 모니터링
  - 대시보드 개발
  - 로그 시스템 구현
  - 알림 기능 추가

### Phase 3: 통합 및 최적화
- 1차/2차 단계 통합 UI
- 전체 시스템 성능 최적화
- 실전 운영 및 피드백 반영

---

## 9. 기술 스택

### 1차 챌린지 단계
- **언어**: Python (메인 로직), MQL5 (MT5 EA)
- **API**: MT5 Python API, Whisper API
- **UI**: PyQt5 또는 Electron
- **보안**: AES256 암호화

### 2차 펀딩 단계 (v1.1 신규)
- **언어**: MQL5 (Expert Advisor)
- **플랫폼**: MetaTrader 5 (2개 독립 인스턴스)
- **통신**:
  - 주: GlobalVariables (MT5 내장)
  - 백업: 파일 I/O (C:\MT5_Shared\)
- **모니터링**: Python 대시보드 (MT5 API 연동)
- **로깅**: CSV (타임스탬프, 이벤트, 지연시간)

---

## 10. 결론

본 시스템은 HDH 전략의 가장 중요한 요소인 **'동기화 체결'을 100% 자동화**하여 전략 붕괴 위험을 제거하는 핵심 기술이다.

**v1.1 업데이트**를 통해 **2차 펀딩 단계의 가장 큰 리스크인 '타이밍 오차'를 20-80ms 수준으로 최소화**하는 자동화 시스템을 추가하였다.

### 핵심 성과 목표

| 단계 | 기존 (수동) | 자동화 후 | 개선율 |
|------|------------|----------|--------|
| 1차 챌린지 동시 진입 | 500-2000ms 오차 | <50ms | 90%+ |
| 2차 펀딩 SL 대응 청산 | 1-5초 (수동 감지+클릭) | 20-80ms | 95%+ |
| 인간 실수율 | 5-10% | <0.1% | 99%+ |

원클릭·음성·자동파라미터·위험감지 기능들이 결합되어 **1차 및 2차 모든 단계에서 안정적인 전략 실행**이 가능하도록 설계되었다.

**2차 펀딩 단계 자동화의 핵심 가치**:
- ✅ 손절 시 반대 계좌 즉시 청산으로 **추가 손실 방지**
- ✅ 인간 반응속도(1-2초) 대비 **95% 이상 타이밍 개선**
- ✅ 24시간 무인 모니터링 가능
- ✅ 심리적 스트레스 제거 (수동 감시 불필요)

이로써 HDH 전략은 **완전 자동화 가능한 수익 구조**로 완성된다.
